meta:
  engine: 4.1.0
  version: 0.0.1
  author: n1tsu

units:
  # keys
  keycaps_size: 16
  keycaps_padding: 1
  keycap_dist: keycaps_size+keycaps_padding
  kd: keycaps_size+keycaps_padding
  qcol_stagger: 0kd
  wcol_stagger: 0.5kd
  ecol_stagger: 0.25kd
  rcol_stagger: -0.125kd
  tcol_stagger: -0.125kd
  ycol_stagger: -0.125kd
  thumb_splay: 15

  # BOARD
  bp_t: 12
  bp_b: 14
  bp_r: 30 
  bp_l: 12
  # case
  case_edge_size: 0

  # components
  components_padding: 4
  nicenano_width: 17.78
  nicenano_height: 33
  battery_width: 30
  battery_height: 12
  battery_connector_width: 0.4U # !
  battery_connector_height: 0.8U # !
  power_width: 2.7
  power_height: 7.8
  power_button_size: 1.5
  reset_width: 4.5
  reset_height: 6.4

  #components_loc
  controller_rel_x: 3*kd+20
  controller_rel_y: bp_t - nicenano_height * 0.5 

  battery_rel_x: kd+20
  battery_rel_y: -7 

points:
  zones:
    matrix:
      key:
        spread: keycaps_size + keycaps_padding
        tags: "keys"
      anchor.shift: [50, -100]
      columns:
        qcolumn.key.stagger: qcol_stagger
        wcolumn.key.stagger: wcol_stagger
        ecolumn.key.stagger: ecol_stagger
        rcolumn.key.stagger: rcol_stagger
        tcolumn.key.stagger: tcol_stagger
        ycolumn.key.stagger: ycol_stagger
      rows:
        zrow.padding: keycaps_size + keycaps_padding
        arow.padding: keycaps_size + keycaps_padding
        qrow.padding: keycaps_size + keycaps_padding

    thumb:
      key:
        tags: "keys"
        spread: keycap_dist
        padding: keycap_dist
      anchor:
        ref: matrix_rcolumn_zrow
        shift: [0, -keycap_dist]
      columns:
        inner:
        middle.key:
          stagger: tcol_stagger
        outer.key:
          stagger: ycol_stagger

    controller:
      anchor:
        ref: matrix_ecolumn_qrow
        shift: [controller_rel_x, controller_rel_y]

    # controller:
    #   anchor:
    #     ref: matrix_tcolumn_qrow
    #     shift: [-6.5, 22]
    #     rotate: 90

    # battery:
    #   anchor:
    #     ref: matrix_tcolumn_qrow
    #     shift: [18, -28]
    #     rotate: 90

    battery:
      anchor:
        ref: matrix_tcolumn_zrow
        shift: [battery_rel_x, battery_rel_y]
        rotate: 90

  mirror:
    ref: matrix_rcolumn_arow
    distance: 140

outlines:
  keycaps:
    - what: rectangle
      where: keys
      size: keycaps_size
      asym: both

  # BOARD OUTLINE
  board:
    - what: polygon
      operation: stack
      fillet: 1
      points:
        - ref: matrix_ecolumn_qrow
          shift: [-2*keycap_dist -bp_l, bp_t]
        - ref: matrix_ecolumn_qrow
          shift: [3*keycap_dist+bp_r, bp_t]
        - ref: matrix_ecolumn_zrow
          shift:
            [3*keycap_dist+bp_r, rcol_stagger+  tcol_stagger - keycap_dist-bp_b]
        - ref: matrix_ecolumn_zrow
          shift:
            [
              -2*keycap_dist- bp_l,
              rcol_stagger+  tcol_stagger - keycap_dist -bp_b,
            ]

  controller:
    - what: rectangle
      where: controller
      size: [nicenano_width, nicenano_height]
      asym: both
      adjust.rotate: 0

  battery:
    - what: rectangle
      where: battery
      size: [battery_width, battery_height]
      asym: both
      # adjust.rotate: 0

  combo:
    - operation: stack
      name: keycaps
    - operation: stack
      name: board
    - operation: stack
      name: controller
    - operation: stack
      name: battery

  combo2:
    - operation: stack
      name: keycaps
    - operation: stack
      name: board
    # - operation: stack
    #   name: controller
    # - operation: stack
    #   name: battery

pcbs:
  main_pcb:
    outlines:
      main:
        outline: board
      # battery:
      #   outline: battery
      #   layer: "F.SilkS"

    template: kicad8
    footprints:
      switch:
        what: pg1316s
        where: keys
        params:
          from: "{{column_net}}"
          to: "{{colrow}}"

      diodes_left:
        what: diode_tht_sod123
        where: /^matrix_.*|^thumb_.*/
        params:
          side: "F"
          from: "{{colrow}}"
          to: "{{row_net}}"
        adjust:
          shift: [0.3, 2.4]
      diodes_right:
        what: diode_tht_sod123
        where: /^mirror_matrix_.*|^mirror_thumb_.*/
        params:
          side: "F"
          from: "{{colrow}}"
          to: "{{row_net}}"
        adjust:
          shift: [-0.3, 2.4]

      # controller footprints isn't mirrored
      # controller_left:
      #   what: nicenano
      #   where: controller
      #   params:
      #     orientation: up
      #   # PCB controller is 90 oriented by default
      #   adjust.rotate: -90 + controller_rotation
      # controller_right:
      #   what: nicenano
      #   where: mirror_controller
      #   params:
      #     orientation: up
      #   # PCB controller is 90 oriented by default
      #   # PCB controller is 90 oriented by default
      #   adjust.rotate: -90 + controller_rotation + 180
      #

      # reset:
      #   what: reset_switch_smd_side
      #   where: reset
      #   params:
      #     include_bosses: true
      #   asym: both
      #   adjust.rotate: reset_rotation
      #
      # holes:
      #   what: mounting_hole_plated
      #   where: holes
      #
      # text:
      #   what: utility_text
      #   where: text
      #   asym: both
      #   params:
      #     side: "F"
      #     mirrored: false
      #     text: "n36tsu v0.1.0"
